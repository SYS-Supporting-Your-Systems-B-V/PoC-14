<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>E-mailadres zoeken (HPD LDAP)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                         Roboto, sans-serif;
            line-height: 1.4;
            color: #1f2933;
            background-color: #f5f7fa;
        }

        body {
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }

        .app {
            width: 100%;
            max-width: 960px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
            padding: 1.75rem 2rem 2rem;
            box-sizing: border-box;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0 0 0.75rem;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #6b7785;
            margin-bottom: 1.25rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1 1 260px;
            min-width: 0;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .radio-group {
            display: flex;
            gap: 1.25rem;
            align-items: center;
            font-size: 0.9rem;
        }

        .radio-group input {
            margin-right: 0.35rem;
        }

        input[type="text"] {
            padding: 0.45rem 0.6rem;
            border-radius: 8px;
            border: 1px solid #cbd2e1;
            font-size: 0.95rem;
            outline: none;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .hint {
            font-size: 0.8rem;
            color: #6b7785;
            margin-bottom: 0.5rem;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 0.45rem 1.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #ffffff;
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.15s;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(37, 99, 235, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 5px 12px rgba(37, 99, 235, 0.35);
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.55;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        .status-line {
            font-size: 0.85rem;
            color: #6b7785;
        }

        .status-line strong {
            color: #111827;
        }

        .status-line .error {
            color: #b91c1c;
        }

        .status-line .ok {
            color: #047857;
        }

        .table-wrapper {
            margin-top: 1rem;
            border-radius: 10px;
            border: 1px solid #d0d7e3;
            overflow: hidden;
            background: #ffffff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            font-size: 0.9rem;
        }

        thead {
            background: #f1f5f9;
        }

        th, td {
            padding: 0.45rem 0.6rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #4b5563;
        }

        tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        tbody tr:hover {
            background: #e0ecff;
        }

        tbody tr {
            cursor: pointer;
        }

        .table-scroll {
            max-height: 360px;
            overflow: auto;
        }

        .small-text {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        @media (max-width: 720px) {
            .app {
                padding: 1.25rem 1.25rem 1.5rem;
            }

            .table-wrapper {
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <h1>E-mailadres zoeken (HPD LDAP)</h1>
    <div class="subtitle">
        Zoeken in een HPD-/LDAP-directory:
        Dubbelklik op een rij om een e-mail te starten (indien beschikbaar).
    </div>

    <form id="search-form">
        <div class="form-row">
            <div class="form-group">
                <label>Zoek in</label>
                <div class="radio-group">
                    <label><input type="radio" name="scope" value="person" checked> persoon</label>
                    <label><input type="radio" name="scope" value="org"> organisatie</label>
                </div>
            </div>

            <div class="form-group">
                <label for="q">Zoektekst</label>
                <input type="text" id="q" name="q" autocomplete="off" maxlength="64"
                       placeholder="bijv. Janssen, info@, poli cardiologie">
            </div>
        </div>

        <div class="hint" id="hint">
            zoekt in: naam (cn), achternaam (sn), voornaam (givenName), e-mail (mail)
        </div>

        <div class="actions">
            <button type="submit" id="search-btn">Zoek</button>
            <span class="status-line" id="status">
                Geen zoekactie uitgevoerd.
            </span>
        </div>
    </form>

    <div class="table-wrapper">
        <div class="table-scroll">
            <table>
                <thead>
                <tr>
                    <th>naam</th>
                    <th>e-mail</th>
                    <th>tel</th>
                    <th>mobiel</th>
                    <th>functie</th>
                    <th>organisatie</th>
                    <th>afdeling</th>
                    <th>DN</th>
                </tr>
                </thead>
                <tbody id="results-body">
                <!-- rijen worden via JavaScript gevuld -->
                </tbody>
            </table>
        </div>
        <div class="small-text" id="footer-info" style="padding: 0.35rem 0.6rem 0.5rem;">
            0 resultaten.
        </div>
    </div>
</div>

<script>
    // === instellingen =======================================================
    // Injected by backend template from PDQM_LDAP_BASE.
    const BASE_URL = {{ ldap_base_url | tojson }};
    const API_KEY = "";                          // laat leeg als geen API key vereist is
    const HPD_LIMIT = 50;                        // vergelijkbaar met HPD_LIMIT in Access

    // === hulpfuncties =======================================================

    function setStatus(text, type) {
        const el = document.getElementById("status");
        el.textContent = text;
        el.className = "status-line";
        if (type === "error") {
            el.classList.add("error");
        } else if (type === "ok") {
            el.classList.add("ok");
        }
    }

    function sanitize(text) {
        if (!text) return "";
        return String(text).replace(/;/g, ",").trim();
    }

    function firstOrEmpty(entry, key) {
        if (!entry || !(key in entry) || entry[key] == null) {
            return "";
        }
        const value = entry[key];
        if (Array.isArray(value)) {
            return value.length > 0 ? String(value[0]) : "";
        }
        return String(value);
    }

    function updateHint(scope) {
        const hint = document.getElementById("hint");
        if (scope === "org") {
            hint.textContent =
                "zoekt in: organisatie (o), afdeling (ou), alias/naam (cn), e-mail (mail)";
        } else {
            hint.textContent =
                "zoekt in: naam (cn), achternaam (sn), voornaam (givenName), e-mail (mail)";
        }
    }

    // === event handlers =====================================================

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("search-form");
        const inputQ = document.getElementById("q");
        const btn = document.getElementById("search-btn");
        const tbody = document.getElementById("results-body");
        const footer = document.getElementById("footer-info");

        // hint updaten bij wisselen radio
        document.querySelectorAll('input[name="scope"]').forEach(function (radio) {
            radio.addEventListener("change", function () {
                updateHint(this.value);
            });
        });

        form.addEventListener("submit", function (evt) {
            evt.preventDefault();

            const query = (inputQ.value || "").trim();
            const scope = document.querySelector('input[name="scope"]:checked').value;

            if (!query) {
                setStatus("Voer een zoekterm in.", "error");
                inputQ.focus();
                return;
            }

            if (query.length > 64) {
                setStatus("Zoekterm is te lang (max. 64 tekens).", "error");
                inputQ.focus();
                return;
            }

            btn.disabled = true;
            setStatus("Zoeken", null);
            tbody.innerHTML = "";
            footer.textContent = "Bezig met zoeken";

            const url = `${BASE_URL}/hpd/search?q=${encodeURIComponent(query)}&scope=${encodeURIComponent(scope)}&limit=${HPD_LIMIT}`;

            const headers = {};
            if (API_KEY && API_KEY.trim().length > 0) {
                headers["X-API-Key"] = API_KEY.trim();
            }

            fetch(url, {
                method: "GET",
                headers: headers
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("HTTP " + response.status + " " + response.statusText);
                    }
                    return response.json();
                })
                .then(function (data) {
                    const items = Array.isArray(data.items) ? data.items : [];
                    let count = 0;

                    items.forEach(function (entry) {
                        const name =
                            sanitize(firstOrEmpty(entry, "displayName")) ||
                            sanitize(firstOrEmpty(entry, "cn"));
                        const email = sanitize(firstOrEmpty(entry, "mail"));
                        const tel = sanitize(firstOrEmpty(entry, "telephoneNumber"));
                        const mobile = sanitize(firstOrEmpty(entry, "mobile"));
                        const title = sanitize(firstOrEmpty(entry, "title"));
                        const org = sanitize(firstOrEmpty(entry, "o"));
                        const ou = sanitize(firstOrEmpty(entry, "ou"));
                        const dn = sanitize(firstOrEmpty(entry, "dn"));

                        if (!name && !email) {
                            return; // overslaan als er niets zinnigs is
                        }

                        const tr = document.createElement("tr");

                        function addCell(text) {
                            const td = document.createElement("td");
                            td.textContent = text || "";
                            tr.appendChild(td);
                        }

                        addCell(name);
                        addCell(email);
                        addCell(tel);
                        addCell(mobile);
                        addCell(title);
                        addCell(org);
                        addCell(ou);
                        addCell(dn);

                        // dubbelklik -> mailto
                        tr.addEventListener("dblclick", function () {
                            if (email) {
                                window.location.href = "mailto:" + email;
                            }
                        });

                        tbody.appendChild(tr);
                        count += 1;
                    });

                    footer.textContent = count + " " + (count === 1 ? "resultaat" : "resultaten") + ".";
                    setStatus("Zoekactie voltooid.", "ok");
                })
                .catch(function (err) {
                    console.error(err);
                    setStatus("Fout bij zoeken: " + err.message, "error");
                    footer.textContent = "0 resultaten (fout).";
                })
                .finally(function () {
                    btn.disabled = false;
                });
        });
    });
</script>
</body>
</html>
